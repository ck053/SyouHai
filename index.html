<html>
    <head>
        <meta charset="UTF-8" />
        <title>Socket.io testing</title>
        <meta name="viewpoint" content="width=devive-width, inditial-scale=1.0" />
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <h1 class="to-delete">Enter Your Name:</h1>
        <input id="input" class="to-delete"></input>
        <button id="button" class="to-delete">search player</button>
        <script src="/socket.io/socket.io.js"></script>
        
        <script type="module">
        const socket=io();
        const roundname = ["東一局","東二局","東三局","南一局","南二局","南三局"];
        var activedbutton = [];
        var kanlist;
        var card;
        var ready_riichi = false;
        var ready_open = false;
        var k;
        var urturn = false;
        function actioned() {
            urturn = false;
            //turn off all button
            let but = document.getElementById("button-area");
            removeAllChildNodes(but);
            activedbutton = [];
        }
        function replyplay(event) {
            if (urturn) {
            const clickedElement = event.target;
            const classList = clickedElement.classList;
            if (ready_open) {
                socket.emit('action', {play:parseInt(classList[1]),room,riichi:2,player:playpos});
                ready_open = false;
            } else if (ready_riichi) {
                socket.emit('action', {play:parseInt(classList[1]),room,riichi:1,player:playpos});
                ready_riichi = false;
            } else {
                socket.emit('action', {play:parseInt(classList[1]),room,riichi:0,player:playpos});
            }
            actioned();
            }
        }
        function removeAllChildNodes(parent) {
            while (parent.firstChild) {
                parent.removeChild(parent.firstChild);
            }
        }
        function addstacktile(card){
            let doubletile = document.createElement("div");
            let tile1 = document.createElement("div");
            tile1.classList.add("exptile1", card);
            tile1.style.backgroundImage = "url('Regular/"+card+".png')";
            doubletile.classList.add("doubletile");
            doubletile.appendChild(tile1);
            let tile2 = document.createElement("div");
            tile2.classList.add("exptile2", card);
            tile2.style.backgroundImage = "url('Regular/"+card+".png')";
            doubletile.classList.add("doubletile");
            doubletile.appendChild(tile2);
            let playerHand = document.getElementById("player-exposed");
            playerHand.appendChild(doubletile);
        }
        function addleftstacktile(card){
            let doubletile = document.createElement("div");
            let tile1 = document.createElement("div");
            tile1.classList.add("leftexptile1", card);
            tile1.style.backgroundImage = `url('Regular/1${card}.png')`;
            doubletile.classList.add("leftdoubletile");
            doubletile.appendChild(tile1);
            let tile2 = document.createElement("div");
            tile2.classList.add("leftexptile2", card);
            tile2.style.backgroundImage = `url('Regular/1${card}.png')`;
            doubletile.classList.add("doubletile");
            doubletile.appendChild(tile2);
            let playerHand = document.getElementById("left-player-exposed");
            playerHand.appendChild(doubletile);
        }
        function addrightstacktile(card){
            let doubletile = document.createElement("div");
            let tile1 = document.createElement("div");
            tile1.classList.add("rightexptile1", card);
            tile1.style.backgroundImage = `url('Regular/2${card}.png')`;
            doubletile.classList.add("rightdoubletile");
            doubletile.appendChild(tile1);
            let tile2 = document.createElement("div");
            tile2.classList.add("rightexptile2", card);
            tile2.style.backgroundImage = `url('Regular/2${card}.png')`;
            doubletile.classList.add("rightdoubletile");
            doubletile.appendChild(tile2);
            let playerHand = document.getElementById("right-player-exposed");
            playerHand.appendChild(doubletile);
        }
        //update hand on screen
        function updateplayerhand(hand = player[playpos][1]['hand'] ,exposed = player[playpos][0]['exposed']) {
            //update player hand
            let playerHand = document.getElementById("player-hand");
            card = [];
            var tile = 0;
            removeAllChildNodes(playerHand);
            for (k = 0; k < hand.length; k++) {
                card.push(hand[k]);
                if (card[k] == 1000){
                    continue;
                }
                tile = document.createElement("div");
                tile.classList.add("tile", card[k] , "hand", "phand");
                if (!k) {
                    tile.style.marginLeft = '40px';
                }
                tile.addEventListener("click", replyplay);
                tile.style.backgroundImage = "url('Regular/"+card[k]+".png')";
                playerHand.appendChild(tile);
                
            }
            //update player exposed
            playerHand = document.getElementById("player-exposed");
            removeAllChildNodes(playerHand);
            if (exposed.length>0) {
                for (let i=exposed.length-1; i>=0; i--) {
                    let relpos = (playpos-exposed[i][1][0]+3)%3;
                    //check type
                    switch (exposed[i][1][1]) {
                        case 0: //暗槓
                            for (let j=0; j < 4; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("exptile", card);
                                tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                if (j==0 || j==3) {
                                    tile.style.backgroundImage ="url('Regular/Back.png')";
                                }
                                playerHand.appendChild(tile);
                            }
                            break;
                        case 1: //明槓
                            for (let j=0; j < 4; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("exptile", card);
                                tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                switch (relpos) {
                                    case 2: //下家
                                        if (j==3) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.marginLeft = '4px';
                                            tile.style.marginRight = '11px';
                                            tile.style.top = '18px'
                                        }
                                        break;
                                    case 3: //對家
                                        if (j==1) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.marginLeft = '4px';
                                            tile.style.marginRight = '11px';
                                            tile.style.top = '18px'
                                        }
                                        break;
                                    case 1: //上家
                                        if (j==0) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.marginLeft = '4px';
                                            tile.style.marginRight = '11px';
                                            tile.style.top = '18px'
                                        }
                                        break;
                                }
                                playerHand.appendChild(tile);
                            }
                            break;
                        case 2: //加槓
                            switch (relpos) {
                                case 2: //下家
                                    addstacktile(exposed[i][0][0]);
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("exptile", card);
                                    tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                    playerHand.appendChild(tile);
                                    tile = document.createElement("div");
                                    tile.classList.add("exptile", card);
                                    tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                    playerHand.appendChild(tile);
                                    break;
                                case 3: //對家
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("exptile", card);
                                    tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                    playerHand.appendChild(tile);
                                    addstacktile(exposed[i][0][0]);
                                    tile = document.createElement("div");
                                    tile.classList.add("exptile", card);
                                    tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                    playerHand.appendChild(tile);
                                    break;
                                case 1: //上家
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("exptile", card);
                                    tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                    playerHand.appendChild(tile);
                                    tile = document.createElement("div");
                                    tile.classList.add("exptile", card);
                                    tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                    playerHand.appendChild(tile);
                                    addstacktile(exposed[i][0][0]);
                                    break;
                            }
                            break; //break case2                  
                        case 3: //吃
                            card = exposed[i][0][2];
                            tile = document.createElement("div");
                            tile.classList.add("exptile", card);
                            tile.style.backgroundImage = "url('Regular/"+card+".png')";
                            tile.style.transform = 'rotate(90deg)';
                            tile.style.marginLeft = '4px';
                            tile.style.marginRight = '11px';
                            tile.style.top = '18px'
                            playerHand.appendChild(tile);
                            card = exposed[i][0][1];
                            tile = document.createElement("div");
                            tile.classList.add("exptile", card);
                            tile.style.backgroundImage = "url('Regular/"+card+".png')";
                            playerHand.appendChild(tile);
                            card = exposed[i][0][0];
                            tile = document.createElement("div");
                            tile.classList.add("exptile", card);
                            tile.style.backgroundImage = "url('Regular/"+card+".png')";
                            playerHand.appendChild(tile);
                            break; //break case3
                        case 4: //碰
                            for (let j=0; j < 3; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("exptile", card);
                                tile.style.backgroundImage = "url('Regular/"+card+".png')";
                                switch (relpos) {
                                    case 2: //下家
                                        if (j==2) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.marginLeft = '4px';
                                            tile.style.marginRight = '11px';
                                            tile.style.top = '18px'
                                        }
                                        break;
                                    case 3: //對家
                                        if (j==1) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.marginLeft = '4px';
                                            tile.style.marginRight = '11px';
                                            tile.style.top = '18px'
                                        }
                                        break;
                                    case 1: //上家
                                        if (j==0) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.marginLeft = '4px';
                                            tile.style.marginRight = '11px';
                                            tile.style.top = '18px'
                                        }
                                        break;
                                }
                                playerHand.appendChild(tile);
                            }
                        break; //break case4
                    }
                }
            }
        }
        function updateleftplayerhand(playernum = previousplayer) {
            let leftplayerHand = document.getElementById("left-player-hand");
            removeAllChildNodes(leftplayerHand);
            if (player[playernum][1]['hand'].length == 0) {
                for (let i=0; i<(12-(player[playernum][0]['exposed'].length*3)); i++) {
                    tile = document.createElement("div");
                    tile.classList.add("lefttile" ,"hand");
                    tile.style.backgroundImage = "url('Regular/TurnBack.png')";
                    leftplayerHand.appendChild(tile);
                }
            } else {
                card = [];
                var tile = 0;
                let hand = player[playernum][1]['hand'];
                for (k = 0; k < hand.length; k++) {
                    card.push(hand[k]);
                    if (card[k] == 1000){
                        continue;
                    }
                    tile = document.createElement("div");
                    tile.classList.add("lefttile", card[k] ,"hand");
                    tile.style.backgroundImage = `url('Regular/1${card[k]}.png')`;
                    leftplayerHand.appendChild(tile);
                }
            }
            //update exposed
            let leftplayerExposed = document.getElementById("left-player-exposed");
            removeAllChildNodes(leftplayerExposed);
            let exposed = player[playernum][0]['exposed'];
            if (exposed.length>0) {
                for (let i=exposed.length-1; i>=0; i--) {
                    let relpos = (previousplayer-exposed[i][1][0]+3)%3;
                    //check type
                    switch (exposed[i][1][1]) {
                        case 0: //暗槓
                            for (let j=0; j < 4; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("Turnedexptile", card);
                                tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                if (j==0 || j==3) {
                                    tile.style.backgroundImage ="url('Regular/TurnBack.png')";
                                }
                                leftplayerExposed.appendChild(tile);
                            }
                            break;
                        case 1: //明槓
                            for (let j=0; j < 4; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("Turnedexptile", card);
                                tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                switch (relpos) {
                                    case 2: //下家
                                        if (j==3) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "0px 0px 4px -7px";
                                        }
                                        break;
                                    case 3: //對家
                                        if (j==1) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "0px 0px 4px -7px";
                                        }
                                        break;
                                    case 1: //上家
                                        if (j==0) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "0px 0px 4px -7px";
                                        }
                                        break;
                                }
                                leftplayerExposed.appendChild(tile);
                            }
                            break;
                        case 2: //加槓
                            switch (relpos) {
                                case 2: //下家
                                    addleftstacktile(exposed[i][0][0]);
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                    leftplayerExposed.appendChild(tile);
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                    leftplayerExposed.appendChild(tile);
                                    break;
                                case 3: //對家
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                    leftplayerExposed.appendChild(tile);
                                    addleftstacktile(exposed[i][0][0]);
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                    leftplayerExposed.appendChild(tile);
                                    break;
                                case 1: //上家
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                    leftplayerExposed.appendChild(tile);
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                    leftplayerExposed.appendChild(tile);
                                    addleftstacktile(exposed[i][0][0]);
                                    break;
                            }
                            break; //break case2                  
                        case 3: //吃
                            card = exposed[i][0][2];
                            tile = document.createElement("div");
                            tile.classList.add("Turnedexptile", card);
                            tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                            tile.style.transform = 'rotate(90deg)';
                            tile.style.margin = "2px -7px 4px";
                            leftplayerExposed.appendChild(tile);
                            card = exposed[i][0][1];
                            tile = document.createElement("div");
                            tile.classList.add("Turnedexptile", card);
                            tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                            leftplayerExposed.appendChild(tile);
                            card = exposed[i][0][0];
                            tile = document.createElement("div");
                            tile.classList.add("Turnedexptile", card);
                            tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                            leftplayerExposed.appendChild(tile);
                            break; //break case3
                        case 4: //碰
                            for (let j=0; j < 3; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("Turnedexptile", card);
                                tile.style.backgroundImage = `url('Regular/1${card}.png')`;
                                switch (relpos) {
                                    case 2: //下家
                                        if (j==2) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "0px 0px 4px -7px";
                                        }
                                        break;
                                    case 3: //對家
                                        if (j==1) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "0px 0px 4px -7px";
                                        }
                                        break;
                                    case 1: //上家
                                        if (j==0) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "0px 0px 4px -7px";
                                        }
                                        break;
                                }
                                leftplayerExposed.appendChild(tile);
                            }
                        break; //break case4
                    }
                }
            }
        }
        function updaterightplayerhand(playernum = nextplayer) {
            let rightplayerHand = document.getElementById("right-player-hand");
            removeAllChildNodes(rightplayerHand);
            console.log(player[playernum][1]['hand']);
            if (player[playernum][1]['hand'].length == 0) {
                for (let i=0; i<(12-(player[playernum][0]['exposed'].length*3)); i++) {
                    tile = document.createElement("div");
                    tile.classList.add("righttile" ,"hand");
                    tile.style.backgroundImage = "url('Regular/TurnBack.png')";
                    rightplayerHand.appendChild(tile);
                }
            } else {
                card = [];
                var tile = 0;
                let hand = player[playernum][1]['hand'];
                for (k = 0; k < hand.length; k++) {
                    card.push(hand[k]);
                    if (card[k] == 1000){
                        continue;
                    }
                    tile = document.createElement("div");
                    tile.classList.add("turnedtile", card[k] ,"hand");
                    tile.style.backgroundImage = `url('Regular/2${card[k]}.png')`;
                    rightplayerHand.appendChild(tile);
                }
            }
            //update exposed
            let rightplayerExposed = document.getElementById("right-player-exposed");
            removeAllChildNodes(rightplayerExposed);
            let exposed = player[playernum][0]['exposed'];
            if (exposed.length>0) {
                for (let i=0; i < exposed.length; i++) {
                    let relpos = (nextplayer-exposed[i][1][0]+3)%3;
                    //check type
                    switch (exposed[i][1][1]) {
                        case 0: //暗槓
                            for (let j=0; j < 4; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("Turnedexptile", card);
                                tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                if (j==0 || j==3) {
                                    tile.style.backgroundImage ="url('Regular/TurnBack.png')";
                                }
                                rightplayerExposed.appendChild(tile);
                            }
                            break;
                        case 1: //明槓
                            for (let j=0; j < 4; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("Turnedexptile", card);
                                tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                switch (relpos) {
                                    case 1: //下家
                                        if (j==3) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "3px -6px 5px 0px";
                                        }
                                        break;
                                    case 3: //對家
                                        if (j==1) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "3px -6px 5px 0px";
                                        }
                                        break;
                                    case 2: //上家
                                        if (j==0) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "3px -6px 5px 0px";
                                        }
                                        break;
                                }
                                rightplayerExposed.appendChild(tile);
                            }
                            break;
                        case 2: //加槓
                            switch (relpos) {
                                case 1: //下家
                                    addrightstacktile(exposed[i][0][0]);
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                    rightplayerExposed.appendChild(tile);
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                    rightplayerExposed.appendChild(tile);
                                    break;
                                case 3: //對家
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                    rightplayerExposed.appendChild(tile);
                                    addrightstacktile(exposed[i][0][0]);
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                    rightplayerExposed.appendChild(tile);
                                    break;
                                case 2: //上家
                                    card = exposed[i][0][0];
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                    rightplayerExposed.appendChild(tile);
                                    tile = document.createElement("div");
                                    tile.classList.add("Turnedexptile", card);
                                    tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                    rightplayerExposed.appendChild(tile);
                                    addrightstacktile(exposed[i][0][0]);
                                    break;
                            }
                            break; //break case2                  
                        case 3: //吃
                            card = exposed[i][0][2];
                            tile = document.createElement("div");
                            tile.classList.add("Turnedexptile", card);
                            tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                            tile.style.transform = 'rotate(90deg)';
                            tile.style.margin = "3px -6px 5px 0px";
                            rightplayerExposed.appendChild(tile);
                            card = exposed[i][0][1];
                            tile = document.createElement("div");
                            tile.classList.add("Turnedexptile", card);
                            tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                            rightplayerExposed.appendChild(tile);
                            card = exposed[i][0][0];
                            tile = document.createElement("div");
                            tile.classList.add("Turnedexptile", card);
                            tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                            rightplayerExposed.appendChild(tile);
                            break; //break case3
                        case 4: //碰
                            for (let j=0; j < 3; j++) {
                                card = exposed[i][0][j];
                                tile = document.createElement("div");
                                tile.classList.add("Turnedexptile", card);
                                tile.style.backgroundImage = `url('Regular/2${card}.png')`;
                                switch (relpos) {
                                    case 1: //下家
                                        if (j==2) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "3px -6px 5px 0px";
                                        }
                                        break;
                                    case 3: //對家
                                        if (j==1) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "3px -6px 5px 0px";
                                        }
                                        break;
                                    case 2: //上家
                                        if (j==0) {
                                            tile.style.transform = 'rotate(90deg)';
                                            tile.style.margin = "3px -6px 5px 0px";
                                        }
                                        break;
                                }
                                rightplayerExposed.appendChild(tile);
                            }
                        break; //break case4
                    }
                }
            }
        }
        function updatedora() {
            let dora = document.getElementById("doraind");
            removeAllChildNodes(dora);
            for (let i=0;i<5;i++) {
                if(typeof gamedata[0]['dora'][i] !== 'undefined') {
                    let tile = document.createElement("div");
                    tile.classList.add('dora');
                    tile.style.backgroundImage = "url('Regular/"+gamedata[0]['dora'][i]+".png')";
                    dora.appendChild(tile);
                } else {
                    let tile = document.createElement("div");
                    tile.classList.add('dora');
                    tile.style.backgroundImage = "url('Regular/Back.png')";
                    dora.appendChild(tile);
                }
            }
        }
        //turn on button num
        function enablebutton(num, involved) {
        if (activedbutton.includes(num)) {
            return;
        }
        //create a button
        var button = document.createElement("button");
        //get the button area
        const buttonarea = document.getElementById("button-area");
        switch (num) {
            case 0: //吃
                //set the text
                button.innerHTML = "吃";
                //add an event listener
                button.addEventListener("click", function(){
                    alert("Chi!!!");
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-0';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
            case 1: //碰
                //set the text
                button.innerHTML = "碰";
                //add an event listener
                button.addEventListener("click", function(){
                    //check if more than one option
                    if ((involved == 35) && (player[playpos][1]['hand'][player[playpos][1]['hand'].indexOf(35)+2] == 35) && (player[playpos][1]['hand'].includes(30))) {
                        //create a window
                        const newwindow = document.createElement("div");
                        let board = document.getElementById("game-board");
                        newwindow.id = ("choice");
                        board.appendChild(newwindow);
                        let closebutton = document.createElement("button");
                        closebutton.textContent = "X";
                        closebutton.id = ("closebutton");
                        closebutton.addEventListener("click", () => {
                            newwindow.remove();
                        })
                        newwindow.appendChild(closebutton);
                        let text = document.createElement("p");
                        text.textContent = "選擇要碰的牌";
                        text.id = "pongtext";
                        newwindow.appendChild(text);
                        //addtile to it
                        k = document.createElement("div");
                        k.classList.add("tile");
                        k.style.backgroundImage = "url('Regular/35.png')";
                        k.addEventListener("click", () => {
                            player[playpos][0]['menzen'] = false;
                            socket.emit('pong', {tile:35, room, player:playpos});
                            newwindow.remove();
                            actioned();
                            newwindow.appendChild(k);
                        });
                        k = document.createElement("div");
                        k.classList.add("tile");
                        k.style.backgroundImage = "url('Regular/30.png')";
                        k.addEventListener("click", () => {
                            player[playpos][0]['menzen'] = false;
                            socket.emit('pong', {tile:30, room, player:playpos});
                            newwindow.remove();
                            actioned();
                            newwindow.appendChild(k);
                        });
                        player[playpos][0]['menzen'] = false;
                    } else if ((involved == 55) && (player[playpos][1]['hand'][player[playpos][1]['hand'].indexOf(55)+2] == 55) && (player[playpos][1]['hand'].includes(50))) {
                        //create a window
                        const newwindow = document.createElement("div");
                        let board = document.getElementById("game-board");
                        newwindow.id = ("choice");
                        board.appendChild(newwindow);
                        let closebutton = document.createElement("button");
                        closebutton.textContent = "X";
                        closebutton.id = ("closebutton");
                        closebutton.addEventListener("click", () => {
                            newwindow.remove();
                        })
                        newwindow.appendChild(closebutton);
                        let text = document.createElement("p");
                        text.textContent = "選擇要碰的牌";
                        text.id = "pongtext";
                        newwindow.appendChild(text);
                        //addtile to it
                        k = document.createElement("div");
                        k.classList.add("tile");
                        k.style.backgroundImage = "url('Regular/55.png')";
                        k.addEventListener("click", () => {
                            player[playpos][0]['menzen'] = false;
                            socket.emit('pong', {tile:55, room, player:playpos});
                            newwindow.remove();
                            actioned();
                            newwindow.appendChild(k);
                        });
                        k = document.createElement("div");
                        k.classList.add("tile");
                        k.style.backgroundImage = "url('Regular/50.png')";
                        k.addEventListener("click", () => {
                            player[playpos][0]['menzen'] = false;
                            socket.emit('pong', {tile:50, room, player:playpos});
                            newwindow.remove();
                            actioned();
                            newwindow.appendChild(k);
                        });
                    } else {
                        if (involved == 35 && player[playpos][1]['hand'].includes(30)) {
                            socket.emit("pong", {room, player:playpos, tile:30});
                        } else if (involved == 55 && player[playpos][1]['hand'].includes(50)) {
                            socket.emit("pong", {room, player:playpos, tile:50});
                        } else {
                            socket.emit("pong", {room, player:playpos, tile:involved});
                        }
                        actioned();
                        player[playpos][0]['menzen'] = false;
                    }
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-1';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
            case 2: //明槓
                //set the text
                button.innerHTML = "槓";
                //add an event listener
                button.addEventListener("click", function(){
                    player[playpos][0]['menzen'] = false;
                    actioned();
                    socket.emit("melded kan",{room,player:playpos,tile:gamedata[0]['lastplay']})
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-2';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
            case 3: //暗槓or加槓
                //set the text
                button.innerHTML = "槓";
                //add an event listener
                button.addEventListener("click", function(){
                    //get the tile to kan
                    //check if more than one option
                    if (kanlist.flat().length == 1) {
                        //kan directly if no choice
                        actioned();
                        socket.emit('kan', {kantile:kanlist.flat()[0],room,player:playpos});
                    } else {
                        //TODO:create choice
                        //create a window
                        const newwindow = document.createElement("div");
                        let board = document.getElementById("game-board");
                        newwindow.id = ("choice");
                        board.appendChild(newwindow);
                        let closebutton = document.createElement("button");
                        closebutton.textContent = "X";
                        closebutton.id = ("closebutton");
                        closebutton.addEventListener("click", () => {
                            newwindow.remove();
                        })
                        newwindow.appendChild(closebutton);
                        let kantext = document.createElement("p");
                        kantext.textContent = "選擇要開槓的牌";
                        kantext.id = "kantext";
                        newwindow.appendChild(kantext);
                        //addtile to it
                        kanlist.flat().forEach(element => {
                            k = document.createElement("div");
                            k.classList.add("tile");
                            k.style.backgroundImage = "url('Regular/"+element+".png')";
                            k.addEventListener("click", () => {
                                if (kanlist[0].includes(element)){
                                    console.log(playpos);
                                    socket.emit('kan', {kantile:parseInt(element),room,player:playpos});
                                } else {
                                    socket.emit('kan', {kantile:parseInt(element)+200,room,player:playpos});
                                }
                                
                                newwindow.remove();
                                actioned();
                            })
                            newwindow.appendChild(k);
                        });
                    }
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-3';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
            case 4: //立直
                //set the text
                button.innerHTML = "立直";
                //add an event listener
                button.addEventListener("click", function(){
                    if (!ready_open && !ready_riichi) {//ready for open riichi
                    ready_riichi = true;
                    //dark the card that don't lead to tenpai
                    let hand_tile = document.getElementsByClassName("phand");
                    for (let i=0; i<hand_tile.length; i++) {
                        //check furiten
                        if (typeof player[playpos][1].tenpai[hand_tile[i].classList[1]] === "undefined") {
                            //darken the tile
                            hand_tile[i].style.filter = "brightness(50%)";
                            hand_tile[i].removeEventListener("click", replyplay);
                        } else {
                            let can_riichi = true;
                            for (let j=0; j<player[playpos][1]['furiten'].length; j++){
                            if (player[playpos][1]['tenpai'][hand_tile[i].classList[1]].includes(player[playpos][1]['furiten'][j])) {
                                can_riichi = false;
                            }
                            if (!can_riichi) {
                                //darken the tile
                                hand_tile[i].style.filter = "brightness(50%)";
                                hand_tile[i].removeEventListener("click", replyplay);
                            }
                        }
                        }
                    }}
                    //cancel riichi on second press
                    else if (ready_riichi) {
                        ready_riichi = false;
                        //reflash the hand
                        updateplayerhand(player[playpos][1]['hand'],player[playpos][1]['exposed']);
                    }
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-4';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
            case 5: //開立直
                //set the text
                button.innerHTML = "開立直";
                //add an event listener
                button.addEventListener("click", function(){
                    if (!ready_riichi && !ready_open) {//ready for open riichi
                    ready_open = true;
                    //dark the card that don't lead to tenpai
                    let hand_tile = document.getElementsByClassName("phand");
                    for (let i=0; i<hand_tile.length; i++) {
                        console.log(player[playpos][1].tenpai);
                        console.log(player[playpos][1]);
                        console.log(hand_tile[i].classList[2]);
                        if (typeof player[playpos][1].tenpai[hand_tile[i].classList[1]] === "undefined") {
                            //darken the tile
                            hand_tile[i].style.filter = "brightness(50%)";
                            hand_tile[i].removeEventListener("click", replyplay);
                        }
                    }}
                    //cancel oprn riichi on second press
                    else if (ready_open) {
                        ready_open = false;
                        //reflash the hand
                        updateplayerhand(player[playpos][1]['hand'],player[playpos][1]['exposed']);
                    }
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-5';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
            case 6: //榮和
                //set the text
                button.innerHTML = "榮和";
                //add an event listener
                button.addEventListener("click", function(){
                    socket.emit("ron", {player:playpos,room});
                    actioned();
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-6';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
                break;
            case 7: //自摸
                //set the text
                button.innerHTML = "自摸";
                //add an event listener
                button.addEventListener("click", function(){
                    socket.emit('zumo', {player:playpos,room});
                    actioned();
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-7';
                //child the button to the area
                buttonarea.appendChild(button);
                break;
            case 8: //跳過
                //set the text
                button.innerHTML = "跳過";
                //add an event listener
                button.addEventListener("click", function(){
                    socket.emit("skip", {player:playpos,room});
                    actioned();
                });
                //give class and id to it
                button.classList.add("action-button");
                button.id = 'button-8';
                //child the button to the area
                buttonarea.appendChild(button);
                break;    
            default: console.error("Invalid number of button")
        }
        activedbutton.push(num);
        }
        function deletebutton() {
            if (activedbutton.includes(8)) {
                let cancel = document.getElementById("button-8");
                let buttonarea = document.getElementById("button-area");
                buttonarea.removeChild(cancel);
            }
        }
        //update the discard area
        var discardarea;
        var distile;
        function updateplayerdiscard(play) {
            let updatepos = (playpos-play+3)%3;
            switch (updatepos) {
                case 0:
                    discardarea = document.getElementById("owndiscard");
                    break;
                case 1:
                    discardarea = document.getElementById("leftdiscard");
                    break;
                case 2:
                    discardarea = document.getElementById("rightdiscard");
                    break;
                default:
                    console.error("ilegal update pos")
            }
            removeAllChildNodes(discardarea);
            if (typeof player[play][0]['discard'] !== 'undefined'){
                for (let i = 0; i < player[play][0]['discard'].length; i++) {
                distile = document.createElement("div");
                if (player[play][0]['discard'][i] > 100) {
                    player[play][0]['discard'][i] -= 100; 
                    distile.classList.add("turnedtile", player[play][0]['discard'][i] ,"discard");
                    if (updatepos == 0) {
                    distile.style.backgroundImage = `url('Regular/2${player[play][0]['discard'][i]}.png')`;
                    }
                    if (updatepos == 1) {
                        distile.style.backgroundImage = `url('Regular/${player[play][0]['discard'][i]}.png')`;
                    }
                    if (updatepos == 2) {
                        distile.style.backgroundImage = `url('Regular/${player[play][0]['discard'][i]}.png')`;
                    }
                    discardarea.appendChild(distile);
                } else {
                    distile.classList.add("tile", player[play][0]['discard'][i] ,"discard");
                    if (updatepos == 0) {
                        distile.style.backgroundImage = "url('Regular/"+player[play][0]['discard'][i]+".png')";
                    }
                    if (updatepos == 1) {
                        distile.style.backgroundImage = `url('Regular/1${player[play][0]['discard'][i]}.png')`;
                    }
                    if (updatepos == 2) {
                        distile.style.backgroundImage = `url('Regular/2${player[play][0]['discard'][i]}.png')`;
                    }
                    discardarea.appendChild(distile);
                }
               }
            }
            
        }    
            var room = 'default';
            let input1 = document.getElementById("input");
            var gamedata;
            var urname;
            var playpos;
            var nextplayer;
            var previousplayer;
            var player = [];
            document.getElementById('button').addEventListener("click", () => {
                if (input1.value == '') {
                    alert("enter your name!!!");
                } else {
                    urname = input1.value;
                    console.log(urname);
                    console.log(urname == '');
                    socket.emit('find', urname);
                }
            })
            socket.on("ilegal name", iname => {
                alert(`Player named "${iname}" is online already or you are already online!!!`);
            })
            //check if you are assigned into a room
            socket.on("found", e => {
                console.log("found received")
                if (e.namelist.includes(urname)) {
                    console.log("join required")
                    socket.emit("join room", {room:e.ranint,name:urname});
                    room = e.ranint;
                }
            })
            //receive gamedata from server and update the screen
            socket.on("joined room", e=> {
                //loadgamedata
                gamedata = e.stat[3];
                //set position
                playpos = e.position;
                nextplayer = (playpos+1)%3;
                previousplayer = (playpos+2)%3;
                //load player info;
                player[0] = e.stat[0];
                player[1] = e.stat[1];
                player[2] = e.stat[2];
                //update screen
                const elements = document.getElementsByClassName('to-delete');
                while (elements.length > 0) {
                elements[0].parentNode.removeChild(elements[0]);
                }
                //update the frame
                document.body.style.backgroundColor = "lightgray";
                const gameboard = document.createElement("div");
                gameboard.id = "game-board";
                gameboard.classList.add("game-board");
                document.body.appendChild(gameboard);
                const oppdiscard = document.createElement("div");
                oppdiscard.classList.add("oppdiscard");
                oppdiscard.id = "oppdiscard";
                gameboard.appendChild(oppdiscard);
                const leftdiscard = document.createElement("div");
                leftdiscard.classList.add("leftdiscard");
                leftdiscard.id = "leftdiscard";
                gameboard.appendChild(leftdiscard);
                const rightdiscard = document.createElement("div");
                rightdiscard.classList.add("rightdiscard");
                rightdiscard.id = "rightdiscard";
                gameboard.appendChild(rightdiscard);
                const owndiscard = document.createElement("div");
                owndiscard.classList.add("owndiscard");
                owndiscard.id = "owndiscard";
                gameboard.appendChild(owndiscard);
                const playerhand = document.createElement("div");
                playerhand.classList.add("player-hand");
                playerhand.id = "player-hand"
                gameboard.appendChild(playerhand);
                const leftplayerhand = document.createElement("div");
                leftplayerhand.classList.add("left-player-hand");
                leftplayerhand.id = "left-player-hand"
                gameboard.appendChild(leftplayerhand);
                const rightplayerhand = document.createElement("div");
                rightplayerhand.classList.add("right-player-hand");
                rightplayerhand.id = "right-player-hand"
                gameboard.appendChild(rightplayerhand);
                const playerexposed = document.createElement("div");
                playerexposed.classList.add("player-exposed");
                playerexposed.id = "player-exposed"
                gameboard.appendChild(playerexposed);
                const leftplayerexposed = document.createElement("div");
                leftplayerexposed.classList.add("left-player-exposed");
                leftplayerexposed.id = "left-player-exposed"
                gameboard.appendChild(leftplayerexposed);
                const rightplayerexposed = document.createElement("div");
                rightplayerexposed.classList.add("right-player-exposed");
                rightplayerexposed.id = "right-player-exposed"
                gameboard.appendChild(rightplayerexposed);
                const centreboard = document.createElement("div");
                centreboard.classList.add("centreboard");
                centreboard.id = "centreboard";
                gameboard.appendChild(centreboard);
                const pointleft = document.createElement("div");
                pointleft.id = "point-left";
                pointleft.innerHTML = gamedata[0]['point'][previousplayer];
                centreboard.appendChild(pointleft);
                const pointright = document.createElement("div");
                pointright.id = "point-right";
                pointright.innerHTML = gamedata[0]['point'][nextplayer];
                centreboard.appendChild(pointright);
                const pointself = document.createElement("div");
                pointself.id = "point-self";
                pointself.innerHTML = gamedata[0]['point'][playpos];
                centreboard.appendChild(pointself);
                const doraindicate = document.createElement('div');
                doraindicate.id = "doraind";
                centreboard.appendChild(doraindicate);
                const roundinfo = document.createElement('div');
                roundinfo.id = "roundinfo";
                centreboard.appendChild(roundinfo);
                const buttonarea = document.createElement("div");
                buttonarea.classList.add("button-area");
                buttonarea.id = "button-area"
                gameboard.appendChild(buttonarea);
                player[(playpos+1)%3][1]['hand'].pop();
                player[(playpos+2)%3][1]['hand'].pop();
                updateleftplayerhand((playpos+1)%3);
                updaterightplayerhand((playpos+1)%3);
                //reply ready message to server
                socket.emit("ready", {room,playpos});
            })
            //update hand on receive
            socket.on("hand update", e => {
                console.log("hand update received")
                if (e.last == 0) {
                    //update hand only
                    player[playpos][1]['hand'] = e.stat;
                    //update image on screen
                    updateplayerhand(e.stat,player[playpos][0]['exposed']);
                }
                gamedata[0]['dora'].push(e.dora);
                let round = document.getElementById('roundinfo');
                round.textContent = `${roundname[gamedata[0]['rounds']]}${gamedata[0]['continueround']}本場${gamedata[0]['riichideposit']}供托`;
                updatedora();
            })
            socket.on("drawaction", e => {
                player[playpos][1] = e.hand;
                gamedata[1]['lastdrawn'] = e.last;
                kanlist = e.action;
                urturn = true;
                /*let getele = document.getElementById("player-hand").children;
                document.getElementById("player-hand").children.foreach(function(elements) {
                    tile.addEventListener("click", function() {
                    console.log("action emited");
                    socket.emit('action', elements.classList(1));
                    });
                });
                for (let i=0;i<getele.length;i++) {
                    getele[i].addEventListener("click", () => {
                    console.log("action emited");
                    //socket.emit('action', getele[i].classList(1));
                    });
                }*/
                //take out the last drawn
                e.hand.hand.splice(e.hand.hand.indexOf(e.last),1);
                e.hand.hand.push(e.last);
                //update the hand
                updateplayerhand(e.hand.hand,player[playpos][0].exposed);
                //check for buhua
                if (e.action == 0) {
                    //do buhua action
                    console.log(e.hand.hand);
                    socket.emit("buhua", {room});
                    //perform buhua animation
                    let hua = document.createElement("div");
                    hua.id = "word";
                    hua.textContent = "花"

                    hua.addEventListener('animationend', () => {
                        setTimeout(() => {
                            hua.remove()
                        }, 300);
                    });
                    document.getElementById("game-board").appendChild(hua);
                } else{
                //check for button
                //check for kan
                if (e.action!==1) {
                    //activate kan button
                    enablebutton(3);
                }
                //check for tenpai
                if (Object.keys(e.hand.tenpai).length !== 0 && player[playpos][0]['menzen']) {
                    enablebutton(5);
                    enablebutton(4);
                }
                //check for zumo
                if (Object.keys(e.hand.winningtile).length !== 0) {
                    enablebutton(7);
                }
                }
                
                
            })
            socket.on("ask ron", e => {
                enablebutton(6);
            })
            socket.on("ask pong", e => {
                enablebutton(1, e.tile);
            })
            socket.on("ask kan", e => {
                enablebutton(2, e.tile);
            })
            socket.on("cancel", e => {
                enablebutton(8);
            })
            socket.on("played", e => {
                //update the discard area
                console.log("played received tile: ", e.tile);
                gamedata[0]["lastplay"] = e.tile;
                player[e.player][0]['discard'] = e.discard;
                if (playpos == e.player && e.tile<100) {
                    player[e.player][1]['hand'].splice(player[e.player][1]['hand'].indexOf(e.tile),1);
                    player[e.player][1]['hand'].sort((a,b) => a-b);
                    updateplayerhand(player[e.player][1]['hand']);
                } else if (playpos == e.player) {
                    updateplayerhand(player[e.player][1]['hand']);
                }
                updateplayerdiscard(e.player);
            })
            socket.on("riichi", e => {
                //riichi animation
            })
            socket.on("openriichi", e => {
                //openriichi animation
                //show hand
                player[e.player][1] = e.data;
                let updatepos = (playpos-e.player+3)%3;
                if (updatepos == 1) {
                    updateleftplayerhand(e.player);
                } 
                if (updatepos == 2) {
                    updaterightplayerhand(e.player);
                } 
            })
            socket.on("zumo", e => {
                //update the hand
                player[e.player][1]['hand'] = e.hand;
                gamedata[1]['ura'] = e.ura;
                //show hand of winning player
                let updatepos = (playpos-e.player+3)%3;
                if (updatepos == 1) {
                    updateleftplayerhand(e.player);
                } 
                if (updatepos == 2) {
                    updaterightplayerhand(e.player);
                } 
            })
            socket.on("ron", e => {

            })
            socket.on("pong", e => {
                //change the data
                console.log(e.exposed);
                gamedata[0]['currentplayer'] = e.byplayer;
                player[e.player][0]['discard'] = e.discard;
                player[e.byplayer][0]['exposed'] = e.exposed;
                //update on screen
                updateplayerdiscard(e.player);
                updateleftplayerhand();
                updaterightplayerhand();
                //TODO:animation of pong
            })
            socket.on("kan", e => {
                //change the data
                gamedata[0]['currentplayer'] = e.byplayer;
                player[e.player][0]['discard'] = e.discard;
                player[e.byplayer][0]['exposed'] = e.exposed;
                gamedata[0]['dora'].push(e.newdora);
                //update on screen
                debugger;
                updateplayerdiscard(e.player);
                updateleftplayerhand();
                updaterightplayerhand();
                updatedora();
            })
            socket.on("pong reply", e => {
                console.log("pong reply received")
                player[playpos][1]['tenpai'] = e.tenpai;
                player[playpos][1]['hand'] = e.hand;
                updateplayerhand();
                urturn = true;
            })
            socket.on("melded kan", e => {
                gamedata[0]['currentplayer'] = e.byplayer;
                player[e.player][0]['discard'] = e.discard;
                player[e.byplayer][0]['exposed'] = e.exposed;
                gamedata[0]['dora'].push(e.newdora);
                //update on screen
                updateplayerdiscard(e.player);
                updateleftplayerhand();
                updaterightplayerhand();
                updatedora();
            })
            socket.on("new round", e => {
                console.log('start new round')
                actioned();
                gamedata[0] = e.data;
                for (let i=0;i<3;i++){ // public
                player[i] = [{
                position: i,
                exposed: [],
                riichi: false,
                ippasu: false,
                discard:[],
                seasontiles:0,
                name: "玩家"+String(i+1),
                menzen:true,
                }, { // private
                hand: [],
                tenpai: {},
                winningtile: {},
                furiten: [],
                }]
                }
                updateleftplayerhand();
                updaterightplayerhand();
                updateplayerdiscard(0);
                updateplayerdiscard(1);
                updateplayerdiscard(2);
            })
        </script>
    </body>
</html>